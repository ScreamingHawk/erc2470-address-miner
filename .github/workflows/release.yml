name: Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GO_VERSION: '1.25'
  BINARY_NAME: 'erc2470-miner'

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: []
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      packages: write

    steps:
      - name: Wait for CI to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Test'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: make deps

      - name: Build binaries
        run: |
          # Build for all platforms
          GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags "-s -w" \
            -o ${{ env.BINARY_NAME }}-windows-amd64.exe \
            ./cmd/erc2470-miner
          
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags "-s -w" \
            -o ${{ env.BINARY_NAME }}-linux-amd64 \
            ./cmd/erc2470-miner
          
          GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags "-s -w" \
            -o ${{ env.BINARY_NAME }}-darwin-amd64 \
            ./cmd/erc2470-miner
          
          GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags "-s -w" \
            -o ${{ env.BINARY_NAME }}-darwin-arm64 \
            ./cmd/erc2470-miner

      - name: Prepare release assets
        run: |
          mkdir -p release
          cp ${{ env.BINARY_NAME }}-* ./release/
          
          # Create checksums
          cd release
          for file in *; do
            sha256sum "$file" > "$file.sha256"
          done
          
          # Create archive for each platform
          for os in windows linux darwin; do
            if ls ${{ env.BINARY_NAME }}-$os-* 1> /dev/null 2>&1; then
              if [ "$os" = "windows" ]; then
                zip -r "${{ env.BINARY_NAME }}-$os.zip" ${{ env.BINARY_NAME }}-$os-*
              else
                tar -czf "${{ env.BINARY_NAME }}-$os.tar.gz" ${{ env.BINARY_NAME }}-$os-*
              fi
            fi
          done
          
          ls -la

      - name: Generate release notes
        id: release_notes
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -n "$LATEST_TAG" ]; then
            # Generate changelog since last tag
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $LATEST_TAG..HEAD 2>/dev/null || git log --pretty=format:"- %s (%h)" --max-count=10)
          else
            # First release
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --max-count=10)
          fi
          
          # Create release notes
          cat > release_notes.md << EOF
          ## What's Changed
          
          $CHANGELOG
          
          ## Installation
          
          Download the appropriate binary for your platform:
          
          - **Windows**: \`${{ env.BINARY_NAME }}-windows.zip\`
          - **Linux**: \`${{ env.BINARY_NAME }}-linux.tar.gz\`
          - **macOS (Intel)**: \`${{ env.BINARY_NAME }}-darwin.tar.gz\`
          - **macOS (Apple Silicon)**: \`${{ env.BINARY_NAME }}-darwin.tar.gz\`
          
          ## Checksums
          
          All binaries are signed with SHA256 checksums for verification.
          EOF
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: |
            release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
